generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 1. USUARIOS
model Usuario {
  id        Int          @id @default(autoincrement())
  nombre    String
  email     String       @unique
  password  String
  rol       Rol          @default(MOZO)
  activo    Boolean      @default(true)
  creadoEn  DateTime     @default(now())
  pedidos   Pedido[]
  cajas     CajaDiaria[]
}

enum Rol {
  ADMIN
  MOZO
  COCINA
  CAJA
}

// 2. CLIENTES Y EMPRESAS
model Empresa {
  id          Int       @id @default(autoincrement())
  razonSocial String
  ruc         String?   @unique
  direccion   String?
  telefono    String?
  activo      Boolean   @default(true)
  empleados   Cliente[]
}

model Cliente {
  id        Int      @id @default(autoincrement())
  nombre    String
  dni       String?
  ruc       String? // Para Facturas Persona Natural
  direccion String?
  telefono  String?
  email     String?
  empresaId Int?
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
  pedidos   Pedido[]
}

// 3. PRODUCTOS
model Categoria {
  id        Int        @id @default(autoincrement())
  nombre    String
  productos Producto[]
}

model Producto {
  id              Int                    @id @default(autoincrement())
  nombre          String
  descripcion     String?
  precio          Decimal                @db.Decimal(10, 2)
  imagenUrl       String?
  categoriaId     Int
  esProductoFinal Boolean                @default(true)
  stock           Int?                   @default(0)
  disponibleHoy   Boolean                @default(true)
  categoria       Categoria              @relation(fields: [categoriaId], references: [id])
  detallesPedido  DetallePedido[]
  movimientos     MovimientoInventario[]
}

// 4. OPERACIONES
model Mesa {
  id      Int      @id @default(autoincrement())
  numero  String   @unique
  ocupada Boolean  @default(false)
  pedidos Pedido[]
}

model Pedido {
  id        Int             @id @default(autoincrement())
  mesaId    Int
  usuarioId Int
  clienteId Int?
  estado    EstadoPedido    @default(PENDIENTE)
  total     Decimal         @db.Decimal(10, 2)
  fecha     DateTime        @default(now())
  mesa      Mesa            @relation(fields: [mesaId], references: [id])
  usuario   Usuario         @relation(fields: [usuarioId], references: [id])
  cliente   Cliente?        @relation(fields: [clienteId], references: [id])
  detalles  DetallePedido[]
  pagos     Pago[]
}

enum EstadoPedido {
  PENDIENTE
  EN_PROCESO
  LISTO
  SERVIDO
  CERRADO
  CANCELADO
}

model DetallePedido {
  id             Int      @id @default(autoincrement())
  pedidoId       Int
  productoId     Int
  cantidad       Int
  precioUnitario Decimal  @db.Decimal(10, 2)
  notas          String?
  pedido         Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto       Producto @relation(fields: [productoId], references: [id])
}

// 5. CAJA Y PAGOS
model CajaDiaria {
  id            Int       @id @default(autoincrement())
  usuarioId     Int
  fechaApertura DateTime  @default(now())
  fechaCierre   DateTime?
  montoInicial  Decimal   @db.Decimal(10, 2)
  montoFinal    Decimal?  @db.Decimal(10, 2)
  observaciones String?
  estado        Boolean   @default(true)
  usuario       Usuario   @relation(fields: [usuarioId], references: [id])
  pagos         Pago[]
}

model Pago {
  id              Int        @id @default(autoincrement())
  pedidoId        Int
  cajaId          Int
  monto           Decimal    @db.Decimal(10, 2)
  metodo          MetodoPago
  fecha           DateTime   @default(now())
  
  // Facturación Electrónica
  comprobanteUrl  String?
  tipoComprobante String?
  serie           String?
  numero          Int?
  sunatEstado     String?
  codigoOperacion String?
  
  pedido          Pedido     @relation(fields: [pedidoId], references: [id])
  caja            CajaDiaria @relation(fields: [cajaId], references: [id])
}

enum MetodoPago {
  EFECTIVO
  YAPE_PLIN
  TARJETA
  CREDITO_EMPRESA
}

// 6. INVENTARIO
model MovimientoInventario {
  id         Int            @id @default(autoincrement())
  productoId Int
  tipo       TipoMovimiento
  cantidad   Int
  fecha      DateTime       @default(now())
  motivo     String?
  producto   Producto       @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
}