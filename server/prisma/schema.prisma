generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Usuario {
  id        Int          @id @default(autoincrement())
  nombre    String
  email     String       @unique
  password  String
  rol       Rol          @default(MOZO)
  activo    Boolean      @default(true)
  creadoEn  DateTime     @default(now())

  pedidos   Pedido[]
  cajas     CajaDiaria[]
  gastos    Gasto[]
}

enum Rol {
  ADMIN
  MOZO
  COCINA
  CAJA
}

model Empresa {
  id             Int       @id @default(autoincrement())
  razonSocial    String
  ruc            String    @unique
  direccion      String?
  telefono       String?
  
  tieneCredito   Boolean   @default(false)
  limiteCredito  Decimal   @default(0)     @db.Decimal(10, 2)
  creditoUsado   Decimal   @default(0)     @db.Decimal(10, 2)
  diaCierre      Int       @default(30)
  
  empleados      Cliente[]
  pedidosCredito Pedido[]
}

model Cliente {
  id              Int      @id @default(autoincrement())
  nombre          String
  dni             String?  @unique
  email           String?
  
  empresaId       Int?
  empresa         Empresa? @relation(fields: [empresaId], references: [id])
  
  pedidos         Pedido[]
}

model Categoria {
  id        Int        @id @default(autoincrement())
  nombre    String
  productos Producto[]
}

model Producto {
  id              Int                    @id @default(autoincrement())
  nombre          String
  descripcion     String?
  precio          Decimal                @db.Decimal(10, 2)
  imagenUrl       String?
  categoriaId     Int
  esProductoFinal Boolean                @default(true)
  stock           Int?                   @default(0)
  disponibleHoy   Boolean                @default(true)
  
  categoria       Categoria              @relation(fields: [categoriaId], references: [id])
  
  detallesPedido  DetallePedido[]
  movimientos     MovimientoInventario[]
}

model Mesa {
  id        Int      @id @default(autoincrement())
  numero    String   @unique
  capacidad Int      @default(4) // <--- AGREGADO: Útil para saber cuántos entran
  ocupada   Boolean  @default(false)
  
  pedidos   Pedido[]
}

model Pedido {
  id        Int          @id @default(autoincrement())
  
  usuarioId Int
  usuario   Usuario      @relation(fields: [usuarioId], references: [id])
  
  clienteId Int?
  cliente   Cliente?     @relation(fields: [clienteId], references: [id])

  mesaId    Int?         // <--- AHORA ES OPCIONAL (Para Delivery)
  mesa      Mesa?        @relation(fields: [mesaId], references: [id])

  esCredito Boolean      @default(false)
  empresaId Int?
  empresa   Empresa?     @relation(fields: [empresaId], references: [id])

  tipo      TipoPedido   @default(MESA) // <--- AGREGADO
  direccion String?      // <--- AGREGADO (Delivery)

  estado    EstadoPedido @default(PENDIENTE)
  total     Decimal      @db.Decimal(10, 2)
  fecha     DateTime     @default(now())
  
  detalles  DetallePedido[]
  pagos     Pago[]
}

enum TipoPedido {
  MESA
  LLEVAR
  DELIVERY
}

enum EstadoPedido {
  PENDIENTE
  EN_PROCESO
  LISTO
  SERVIDO
  CERRADO
  CANCELADO
  POR_FACTURAR
}

model DetallePedido {
  id             Int      @id @default(autoincrement())
  pedidoId       Int
  productoId     Int
  cantidad       Int
  precioUnitario Decimal  @db.Decimal(10, 2)
  notas          String?  // <--- YA EXISTE: Aquí guardaremos "Sin cebolla"
  
  pedido         Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto       Producto @relation(fields: [productoId], references: [id])
}

model CajaDiaria {
  id            Int       @id @default(autoincrement())
  usuarioId     Int
  fechaApertura DateTime  @default(now())
  fechaCierre   DateTime?
  montoInicial  Decimal   @db.Decimal(10, 2)
  montoFinal    Decimal?  @db.Decimal(10, 2)
  observaciones String?
  estado        Boolean   @default(true)
  
  usuario       Usuario   @relation(fields: [usuarioId], references: [id])
  
  pagos         Pago[]
  gastos        Gasto[]   // <--- AGREGADO
}

model Gasto {
  id          Int         @id @default(autoincrement())
  descripcion String
  monto       Decimal     @db.Decimal(10, 2)
  fecha       DateTime    @default(now())
  categoria   String      
  
  usuarioId   Int?
  usuario     Usuario?    @relation(fields: [usuarioId], references: [id])
  
  cajaId      Int?
  caja        CajaDiaria? @relation(fields: [cajaId], references: [id])
}

model Pago {
  id              Int        @id @default(autoincrement())
  pedidoId        Int
  cajaId          Int
  monto           Decimal    @db.Decimal(10, 2)
  metodo          MetodoPago
  fecha           DateTime   @default(now())
  
  comprobanteUrl  String?
  tipoComprobante String?
  serie           String?
  numero          Int?
  sunatEstado     String?
  codigoOperacion String?
  
  pedido          Pedido     @relation(fields: [pedidoId], references: [id])
  caja            CajaDiaria @relation(fields: [cajaId], references: [id])
}

enum MetodoPago {
  EFECTIVO
  YAPE_PLIN
  TARJETA
  CREDITO_EMPRESA
}

model MovimientoInventario {
  id         Int            @id @default(autoincrement())
  productoId Int
  tipo       TipoMovimiento
  cantidad   Int
  fecha      DateTime       @default(now())
  motivo     String?
  
  producto   Producto       @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
}